#!/bin/bash
# hash: {{ include "dot_config/fish/fish_plugins" | sha256sum }}
if command -v fish >/dev/null; then
  fish_dir="$HOME/.config/fish"
  managed=$(chezmoi managed --include=files | grep "^\.config/fish/")

  # remove non-chezmoi-managed .fish files so fisher can install cleanly
  for dir in functions completions conf.d; do
    if [ -d "$fish_dir/$dir" ]; then
      for f in "$fish_dir/$dir"/*.fish; do
        [ -f "$f" ] || continue
        rel=".config/fish/$dir/$(basename "$f")"
        echo "$managed" | grep -qF "$rel" || rm -f "$f"
      done
    fi
  done

  fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher update"
fi
